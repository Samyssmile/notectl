---
---

<div class="playground-wrapper">
	<div class="playground-editor" id="playground-editor"></div>

	<div class="playground-output">
		<div class="output-tabs">
			<button class="output-tab active" data-tab="json">JSON</button>
			<button class="output-tab" data-tab="html">HTML</button>
			<button class="output-tab" data-tab="css-html">CSS HTML</button>
			<button class="output-tab" data-tab="text">Text</button>
		</div>
		<pre class="output-content" id="playground-output"><code>Click a tab to inspect the editor output.</code></pre>
	</div>
</div>

<script>
import {
	AlignmentPlugin,
	BlockquotePlugin,
	CodeBlockPlugin,
	FontPlugin,
	FontSizePlugin,
	HardBreakPlugin,
	HeadingPlugin,
	HighlightPlugin,
	HorizontalRulePlugin,
	ImagePlugin,
	LinkPlugin,
	ListPlugin,
	StrikethroughPlugin,
	SuperSubPlugin,
	TablePlugin,
	TextColorPlugin,
	TextFormattingPlugin,
	PrintPlugin,
	ToolbarOverflowBehavior,
	ThemePreset,
	createEditor,
} from '@notectl/core';
	import { STARTER_FONTS } from '@notectl/core/fonts';

	const container = document.getElementById('playground-editor');
	const output = document.getElementById('playground-output');

	function getStarlightTheme(): ThemePreset {
		return document.documentElement.dataset.theme === 'dark'
			? ThemePreset.Dark
			: ThemePreset.Light;
	}

	if (container && output) {
		const editor = await createEditor({
			theme: getStarlightTheme(),
			toolbar: {
				groups: [
					[
						new FontPlugin({ fonts: [...STARTER_FONTS] }),
						new FontSizePlugin({
							sizes: [10, 12, 14, 16, 18, 20, 24, 28, 32, 48],
							defaultSize: 14,
						}),
					],
					[
						new TextFormattingPlugin({
							bold: true,
							italic: true,
							underline: true,
						}),
						new StrikethroughPlugin(),
						new SuperSubPlugin(),
					],
					[new TextColorPlugin(), new HighlightPlugin()],
					[new HeadingPlugin(), new BlockquotePlugin(), new CodeBlockPlugin()],
					[new AlignmentPlugin()],
					[new ListPlugin()],
					[
						new LinkPlugin(),
						new TablePlugin(),
						new HorizontalRulePlugin(),
						new ImagePlugin(),
						new PrintPlugin(),
					],
				],
				overflow: ToolbarOverflowBehavior.Flow,
			},
			plugins: [new HardBreakPlugin()],
			placeholder: 'Start typing to try notectl...',
			autofocus: false,
		});

		container.appendChild(editor);

		const MAX_OUTPUT_CHARS = 200_000;
		let activeTab = 'json';
		let rafId: number | null = null;
		let idleId: number | null = null;

		function serializeOutput(): string {
			switch (activeTab) {
				case 'json':
					return JSON.stringify(editor.getJSON(), null, 2);
				case 'html':
					return editor.getContentHTML({ pretty: true });
				case 'css-html': {
					const result = editor.getContentHTML({ cssMode: 'classes', pretty: true });
					const cssSection = result.css
						? `/* === CSS === */\n${result.css}`
						: '/* No dynamic styles in document */';
					return `${cssSection}\n\n/* === HTML === */\n${result.html}`;
				}
				case 'text':
					return editor.getText() || '(empty)';
				default:
					return '';
			}
		}

		function renderOutput(text: string): void {
			const code = output?.querySelector('code');
			if (!code) return;

			if (text.length > MAX_OUTPUT_CHARS) {
				code.textContent =
					text.slice(0, MAX_OUTPUT_CHARS) + '\n\n(truncated preview)';
			} else {
				code.textContent = text;
			}
		}

		function updateOutputNow(): void {
			renderOutput(serializeOutput());
		}

		function scheduleOutputUpdate(): void {
			if (rafId !== null) return;

			rafId = requestAnimationFrame(() => {
				rafId = null;
				const text = serializeOutput();
				if (text.length > MAX_OUTPUT_CHARS) {
					const scheduleIdle = window.requestIdleCallback ?? ((cb: () => void) => setTimeout(cb, 0));
					if (idleId !== null) {
						const cancelIdle = window.cancelIdleCallback ?? clearTimeout;
						cancelIdle(idleId);
					}
					idleId = scheduleIdle(() => {
						idleId = null;
						renderOutput(text);
					});
				} else {
					renderOutput(text);
				}
			});
		}

		document.querySelectorAll('.output-tab').forEach((tab) => {
			tab.addEventListener('click', () => {
				document
					.querySelectorAll('.output-tab')
					.forEach((t) => t.classList.remove('active'));
				tab.classList.add('active');
				activeTab =
					(tab as HTMLElement).dataset.tab ?? 'json';
				updateOutputNow();
			});
		});

		editor.on('stateChange', () => {
			scheduleOutputUpdate();
		});

		editor.on('ready', () => {
			updateOutputNow();
		});

		// Sync notectl theme with Starlight's light/dark toggle
		const observer = new MutationObserver(() => {
			editor.setTheme(getStarlightTheme());
		});
		observer.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ['data-theme'],
		});
	}
</script>

<style>
	.playground-wrapper {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		margin-top: 1rem;
	}

	.playground-editor {
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 8px;
		overflow: hidden;
		min-height: 350px;
		background: var(--sl-color-bg);
	}

	:root[data-theme='dark'] .playground-editor {
		border-color: var(--sl-color-gray-4);
	}

	.playground-output {
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 8px;
		overflow: hidden;
	}

	:root[data-theme='dark'] .playground-output {
		border-color: var(--sl-color-gray-4);
	}

	.output-tabs {
		display: flex;
		gap: 0;
		border-bottom: 1px solid var(--sl-color-gray-5);
		background: var(--sl-color-gray-6);
	}

	:root[data-theme='dark'] .output-tabs {
		border-bottom-color: var(--sl-color-gray-4);
		background: var(--sl-color-gray-5);
	}

	.output-tab {
		padding: 0.5rem 1.25rem;
		border: none;
		background: transparent;
		color: var(--sl-color-gray-2);
		cursor: pointer;
		font-size: 0.85rem;
		font-weight: 500;
		font-family: var(--sl-font);
		transition: color 0.15s, background 0.15s;
		border-bottom: 2px solid transparent;
	}

	.output-tab:hover {
		color: var(--sl-color-text);
		background: var(--sl-color-gray-5);
	}

	:root[data-theme='dark'] .output-tab:hover {
		background: var(--sl-color-gray-4);
	}

	.output-tab.active {
		color: var(--sl-color-accent);
		border-bottom-color: var(--sl-color-accent);
	}

	.output-content {
		margin: 0;
		padding: 1rem;
		max-height: 300px;
		overflow: auto;
		font-size: 0.8rem;
		line-height: 1.5;
		background: var(--sl-color-bg);
	}

	.output-content code {
		font-family: var(--sl-font-mono);
		white-space: pre-wrap;
		word-break: break-word;
	}
</style>
